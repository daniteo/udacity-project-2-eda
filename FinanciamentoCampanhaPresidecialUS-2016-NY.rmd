Contribuições da Campanha Presidencial America em 2016, estado de NY por Daniel Teobaldo
========================================================

# Introdução

Para este projeto escolhi uma das bases de dados sugeridas pela Udacity: [Financiamento da Campanha Presidencial dos EUA de 2016](http://classic.fec.gov/disclosurep/pnational.do). Nesta analise optei por fazer a analise das contribuições feitas pelos eleitores do estado de NY.

Este dataset contem 649460 observações e com 18 variaveis.

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Carregue aqui todos os pacotes utilizados 
# na sua análise realizada neste arquivo fonte.

# Note que o parâmetro "echo" foi definido como FALSE neste código.
# Isso previne que o código apresente resultados formatados em HTML.
# Você deve definir echo=FALSE para todos os blocos de código no seu arquivo.

library(ggplot2)
library(GGally)
library(scales)
library(memisc)
library(gridExtra)
library(maptools)
library(zipcode)
library(dplyr)

```

```{r Carregar dados e resumo, echo=FALSE}
# Carregamento dos dados
USACampaign <- read.csv('P00000001-NY.csv', header = T, as.is = T)

USACampaign$cand_id <- as.factor(USACampaign$cand_id)
USACampaign$cand_nm <- as.factor(USACampaign$cand_nm)
USACampaign$contbr_city <- as.character(USACampaign$contbr_city)
#USACampaign$contbr_employer <- as.factor(USACampaign$contbr_employer)
#USACampaign$contbr_occupation <- as.factor(USACampaign$contbr_occupation)

dim(USACampaign)
names(USACampaign)
str(USACampaign)
levels(USACampaign$cand_nm)
summary(USACampaign)
```

# Tratamento de dados

Pelo resultado apresentado do comando `summary(USACampaign)` identifiquei inicialmente duas variáveis que necessitam de tratamento: 
 - *contb_receipt_amt* (valor da contribuição)
 - *contb_receipt_dt* (data da contribuição)
 - *contbr_city* (cidade do contribuinte)

## Campo contb_receipt_amt - Valor da contribuição 

Pelos resumos nota-se que o valor mínimo da contribuição é de U$ 10.100 negativo. Com um filtro dos registros dos dados para contribuições com valores menores ou igual a 0 percebi que existem 8.530 regitros nesta condição.

Uma vez que não existem contirbuições com valor negativo, para estes registros podem ser feitos 2 tipos de tratamentos: considerar o valor absoluto ou eliminá-los do dataset. Vamos considerar que todos os valores deveriam ser positivos e remover do conjunto de dados os registro com contibução igual a 0.

```{r Tratamento dos valores de contribuição, echo=FALSE}
dim(subset(USACampaign, contb_receipt_amt < 0))
USACampaign$contb_receipt_amt <- abs(USACampaign$contb_receipt_amt)
USACampaign <- subset(USACampaign, contb_receipt_amt > 0)
summary(USACampaign$contb_receipt_amt)
```

## Campo contb_receipt_dt - Data da contribuição

Neste caso as datas estão armazenadas como texto no formato DD-MMM-AA. Podemos separar os componentes da data em colunas para dia, mês e ano. Podemos também converter os valores das colunas para tipo data.

```{r Tratamento das datas de contribuição, echo=FALSE}
head(USACampaign$contb_receipt_dt, 50)
USACampaign$contb_receipt_dt_year <- as.factor(paste("20",substr(USACampaign$contb_receipt_dt, 8,9), sep=''))
USACampaign$contb_receipt_dt_month <- substr(USACampaign$contb_receipt_dt, 4,6)
USACampaign$contb_receipt_dt_month <- factor(USACampaign$contb_receipt_dt_month, ordered = T, 
                                                levels=c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", 
                                                             "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"))
USACampaign$contb_receipt_dt_day <- as.factor(substr(USACampaign$contb_receipt_dt, 1,2))   
summary(USACampaign$contb_receipt_dt_year)
summary(USACampaign$contb_receipt_dt_month)
summary(USACampaign$contb_receipt_dt_day)
USACampaign$contb_receipt_date <-  as.Date(USACampaign$contb_receipt_dt, "%d-%b-%y")
summary(USACampaign$contb_receipt_date)
```

## Campo contbr_city - Cidade do contribuinte

No resumo percebi que o número de cidades diferentes dos contribuintes era muito grande (2327 cidades). Numa analise dos dados notei que mesmas cidades estavam registradas com grafia diferentes, por erro ou abreviação do nome. Um exemplo seria o Brooklyn que aparece na base de dados com diversos nomes: BROOKLIN, BROOKLN, BROOKLY, BROOKLYB e BROOKLYN, entre outros.

```{r Tratamento das cidades dos contribuintes 1, echo = FALSE}
head(unique(sort(subset(USACampaign, substr(contbr_city, 1, 4) == "BROO")$contbr_city)), 20)
```

Para o tratamento destas cidades existem duas soluções possíveis:

 - Um mapeamento dos diversos nomes da mesma cidade para um único nome comum
 - Uso de uma base de dados de cidades e mapea-las com base nos ceps (zipcode) dos contribuintes. Optei por esta segunda opção.
 
Neste caso realizei um `left join` da base de dados de financiamento de campanhas com o dataset `zipcode`. Este data set contem CEPs das cidades americanas, com o nome da cidade, estado, longitude e latitude de cada localização. Para este mapeamento foi considerado apenas os 5 primeiros digitos do cep do contribuinte para relação com o dataset `zipcode`.
 
```{r Tratamento das cidades dos contribuintes 2, echo = FALSE}
#Cria um coluna com os 5 primeiros digitos do CEP do contribuinte
USACampaign$zip <- substr(USACampaign$contbr_zip, 1, 5)
#Carrega dataset zipcode e associa com os dados de financiamento
data(zipcode)
USACampaign <- left_join(USACampaign, zipcode, by = 'zip')
USACampaign$state <- as.factor(USACampaign$state)

#Exibe nova estrutura do dataset
names(USACampaign)
summary(USACampaign)

#Verifica registros com cidades indefinidas
summary(subset(USACampaign, is.na(city))$contb_receipt_amt)
table(sort(subset(USACampaign, is.na(city))$contbr_city))

sum(subset(USACampaign, is.na(city))$contb_receipt_amt)
sum(USACampaign$contb_receipt_amt)
sum(subset(USACampaign, is.na(city))$contb_receipt_amt)/sum(USACampaign$contb_receipt_amt)*100
```

Após mapearmos os CEPs, ainda restanram 617 registros para os quais não foram identificados o CEP. Para este registros o valor médio de contribuição é de U$ 178,80. E um total de U$ 110.290,2, equivalente a 0.06% da contribuição total. Com base nestas informações, optei por fazer a exclusão destes registros da base de dados de financiamento de campanha.

```{r Analise dos registros sem cidades definidas, echo = FALSE}
by(subset(USACampaign, is.na(city))$contb_receipt_amt, subset(USACampaign, is.na(city))$cand_nm, summary)

ggplot(aes(x=cand_nm), data=subset(USACampaign, is.na(USACampaign$city)))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

USACampaign <- subset(USACampaign, !is.na(city))
```

# Seção de Gráficos Univariados

```{r Distribuição das doações ao longo do periodo, echo=FALSE}
ggplot(aes(x = contb_receipt_date), data = USACampaign)+
  geom_freqpoly(binwidth=7)+
  scale_x_date(date_breaks = "3 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período')
```

```{r Quantidade de doações por candidato, echo=FALSE}
ggplot(aes(x = contb_receipt_dt_year), data = USACampaign)+
  geom_histogram(binwidth=5, stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x = contb_receipt_dt_month), data = USACampaign)+
  geom_histogram(binwidth=5, stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap( ~contb_receipt_dt_year, ncol = 4)
```

```{r Distribuicão dos valores das contribuições, echo=FALSE}

amt1 <- ggplot(aes(x = contb_receipt_amt), data = USACampaign)+
  geom_histogram(bins=50)+
  xlim(0,quantile(USACampaign$contb_receipt_amt, 0.9))+
  ylim(0, 160000)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

amt2 <- ggplot(aes(x = contb_receipt_amt), data = USACampaign)+
  geom_histogram(bins=50)+
  ylim(0, 160000)+
  scale_x_log10(breaks=c(1,10,100,1000,10000))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

grid.arrange(amt1, amt2, ncol = 2)

```

```{r Contirbuições por cidade, echo=FALSE}
USACampaign.by_city <- USACampaign %>%
                      group_by(city) %>%
                      summarise(count = n()) %>%
                      arrange(count)

main_city <- tail(USACampaign.by_city$city, 10)

ggplot(aes(x = city), data = subset(USACampaign, city %in% main_city))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r Contirbuições por candidato, echo=FALSE}
USACampaign.by_cand <- USACampaign %>%
                       group_by(cand_nm) %>%
                       summarise(qtde = n(),
                       total_valor = sum(contb_receipt_amt),
                       media_valor = mean(contb_receipt_amt),
                       mediana_valor = median(contb_receipt_amt)) %>% 
                       arrange(qtde)

ggplot(aes(x = cand_nm), data = USACampaign)+
  geom_freqpoly(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE}
top3_occupation = head(unique(USACampaign$contbr_occupation), 3)

ggplot(aes(x = cand_nm), data = subset(USACampaign, contbr_occupation %in% top3_occupation))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap( ~contbr_occupation, ncol = 1 )+
  ggtitle('Distribuição das contribuições por candidato entre as 3 principais ocupações do contribuintes')
```

# Análise Univariada

### Qual é a estrutura do conjunto de dados?

O conjunto de dados possui 649443 registros de contribuições para o estado de NY, com 18 atributos cada.

### Quais são os principais atributos de interesse deste conjunto de dados?

Os principais atributos deste conjunto de dados são os candidatos (*cand_nm*) e os valores das contribuições (*contb_receipt_amt*).

### Quais outros atributos você acha que podem lhe auxiliar na investigação destes atributos de interesse?

### Você criou novas variáveis a partir dos atributos existentes no conjunto de dados?

Sim. Foram criados variaveis com os componentes da data de contribuição (dia, mês e ano) e incorporados dados do dataset de CEP (zipcode): cidade, longitude e latitude.

### Dos atributos investigados, distribuições incomuns foram encontradas? Você aplicou operações nos dados para limpá-los, ajustá-los ou mudar a forma dos dados? Se sim, por quê?

Foram realizados tratamentos nos valores de contribuição. Para os valores negativos, foi considerado o valor absoluto. As contribuições zeradas foram eliminadas.

As datas de contribuição carregadas originalmente como `caracter`, foram convertidas para `Date`.

Conforme apresentado na seção de tratamento de dados, fiz uma ajuste nos nomes das cidades para eleminar as cidades iguais registradas com grafias diferentes.

# Seção de Gráficos Bivariados
```{r echo=FALSE, Bivariate_Plots}


```

# Análise Bivariada

### Discuta sobre alguns dos relacionamentos observados nesta parte da investigação. Como os atributos de interesse variaram no conjunto de dados?

### Você observou algum relacionamento interessante entre os outros atributos (os que não são de interesse)?

### Qual foi o relacionamento mais forte encontrado?




# Seção de Gráficos Multivariados

```{r echo=FALSE, Multivariate_Plots}
set.seed(20022012)

```

# Análise Multivariada

### Discuta sobre os relacionamentos observados nesta parte da investigação. Quais atributos que fortaleceram os demais na observação das variáveis de interesse?

### Interações surpreendentes e/ou interessantes foram encontradas entre os atributos?

### OPCIONAL: Modelos foram criados usando este conjunto de dados? Discuta sobre os pontos fortes e as limitações do seu modelo.

------

# Gráficos Finais e Sumário

### Primeiro Gráfico
```{r echo=FALSE, Plot_One}

```

### Descrição do Primeiro Gráfico


### Segundo Gráfico
```{r echo=FALSE, Plot_Two}

```

### Descrição do Segundo Gráfico


### Terceiro Gráfico
```{r echo=FALSE, Plot_Three}

```

### Descrição do Terceiro Gráfico

------

# Reflexão


