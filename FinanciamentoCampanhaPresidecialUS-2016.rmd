
Contribuições da Campanha Presidencial America em 2016, estado do TX por Daniel Teobaldo
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Carregue aqui todos os pacotes utilizados 
# na sua análise realizada neste arquivo fonte.

# Note que o parâmetro "echo" foi definido como FALSE neste código.
# Isso previne que o código apresente resultados formatados em HTML.
# Você deve definir echo=FALSE para todos os blocos de código no seu arquivo.

library(ggplot2)
library(GGally)
library(scales)
library(memisc)
library(gridExtra)
library(maptools)
library(zipcode)
library(dplyr)
library(lubridate)
library(reshape2)
```


Antes de iniciar este trabalho, é necessário descompactar os arquivos de dados e executar o script de tratamento.

```
> tar -zxvf P00000001-TX.tgz 
> tar -zxvf P00000001-NY.tgz 
> python tratarDados.py
```


# Introdução

Para este projeto escolhi uma das bases de dados sugeridas pela Udacity: [Financiamento da Campanha Presidencial dos EUA de 2016](http://classic.fec.gov/disclosurep/pnational.do). 

A idéia inicial era de se fazer a analise do estado de NY, no entanto havia uma discrepancia muito grande nas contibuições uma vez que o comite *"HILLARY VICTORY FUND"* foi responsável por 45% do valor financiado referente a este estado em apenas 23 das 649.460 contribuições registradas, sendo todas elas com valores acima de U$ 100.000.  Este foi o único contribuinte que realizou contribuições acima deste valor. A maior contribuição abaixo deste valor de U$ 100.000 foi de U$ 11.816,25. Poderia ser feita uma remoção dos outliers, porém esta ação traria um dataset que não representa o conjunto de dados do estado. 

```{r Carga dados NY, echo = FALSE, warning = FALSE}
# Carga dos dados
# Carga dos dados dos comites baixados do site do FEC
cmte_data <- read.delim('cm.txt', sep = '|', 
                        header = F, 
                        col.names = c("cmte_id","cmte_nm","TRES_NM",
                                      "CMTE_ST1","CMTE_ST1", "CMTE_CITY",
                                      "CMTE_ST","CMTE_ZIP","cmte_dsgn",
                                      "CMTE_TP","CMTE_PTY_AFFILIATION",
                                      "CMTE_FILING_FREQ",
                                      "ORG_TP","CONNECTED_ORG_NM","CAND_ID"))

cmte_data <- cmte_data[c("cmte_id","cmte_nm","cmte_dsgn")]

#Carga dos dodos de financiamento de NY
USACampaign <- read.csv('P00000001-NY.csv', header = T)
USACampaign <- left_join(USACampaign, cmte_data, by = c("cmte_id"))
rm(cmte_data)
```


```{r Analise NY, warning = FALSE}
#Verifica a distribuição dos valores de controbuições do dataset
summary(USACampaign$contb_receipt_amt)

USACampaign$contb_receipt_amt <- abs(USACampaign$contb_receipt_amt)
USACampaign$contb_range <- cut(USACampaign$contb_receipt_amt, 
                               c(0, 100, 500, 2000, 50000, 
                                 max(USACampaign$contb_receipt_amt)))

#Verifica contribuintes com contribuições superiores a U$ 100.000
USACampaign[USACampaign$contb_receipt_amt >= 100000,]$contbr_nm
#Valor máximo abaixo de U$ 100.000
max(USACampaign[USACampaign$contb_receipt_amt < 100000,]$contb_receipt_amt)

sum(USACampaign[USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED",]$contb_receipt_amt)/sum(USACampaign$contb_receipt_amt)*100

dim(USACampaign[USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED",])

USACampaign$hillary_comitte <- ifelse(USACampaign$contbr_nm == 
                                        "HILLARY VICTORY FUND - UNITEMIZED", "Y", "N")
```

Quando comparamos as contribuições do contribuinte *HILLARY VICTORY FUND - UNITEMIZED* e os demais contribuintes, vemos que o valor total das contribuições são próximos, porém as quantidade de contribuições da comite da Hillary são significamente menores.

```{r Graficos NY, echo = FALSE, warning=FALSE}

#Contribuições HILLARY VICTORY vs OTHERS - Distribuição dos valores e total 
#de contribuição
ggplot(aes(x=hillary_comitte), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  scale_y_continuous(breaks=seq(0, 700000, 50000))+
  xlab("HILLARY VICTORY FUN")+
  ylab("Qtde de contribuições")+
  ggtitle('Comparação das contribuições entre comite da Hillary e outros')


#Distribuição de valores entre as faixas vs total dos valores por faixa
ggplot(aes(x=hillary_comitte, y=contb_receipt_amt/1000), 
       data = USACampaign)+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  xlab("HILLARY VICTORY FUN")+
  ylab("Valor total das contribuições")+
  ggtitle('Comparação da total das contribuições (em milhares)')


```

Abaixo uma comparação entre a quantidade de contribuições realizadas por faixa de valor versus o total arrecadado. Percebe-se que existem epnas 23 doações acima de U$ 50.000 (praticamente não são exibidas no gráfico), mas elas representam uma grande parte no valor total de doações. Para que o histograma na maior faixa de valor (acima de 50.000) fosse exibido, gerei um gráfico com escala logaritima em **y**.

```{r echo = FALSE}
count(USACampaign[USACampaign$contb_receipt_amt > 50000,])

#grafico base de histograma por faixa de valor
g <- ggplot(aes(x=contb_range), 
       data = subset(USACampaign, !is.na(contb_range)))+
  geom_bar(stat = 'count')+
  scale_x_discrete(labels=c("Até 100", 
                            "100-500", 
                            "500-2000",
                            "2000-50000",
                            "Acima de 50000"))+
  ylab("Qtde de contribuições")+
  xlab("Faixa de valores de contribuição")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições em NY')

#Histograma em escala normal
g+
  scale_y_continuous(breaks=seq(0, 600000, 50000))

#Histograma com escala logaritima em y para mostra quantidades na faixa de 
#valores acima de 50000
g+
  scale_y_log10(breaks=c(10, 100, 1000, 10000, 100000),
                labels=c("10", "100", "1000", "10000", "100000"))


ggplot(aes(x=contb_range, y=contb_receipt_amt / 1000), 
       data = subset(USACampaign, !is.na(contb_range)))+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  scale_y_continuous(breaks=seq(0, 90000, 10000))+
  scale_x_discrete(labels=c("Até 100",
                            "100-500",
                            "500-2000",
                            "2000-50000",
                            "Acima de 50000"))+
  xlab("Faixa de valores de contribuição")+
  ylab("Valor total de contribuições (em milhares)")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Valor das doações em NY (em milhares)')

```

É possível notar também o impacto das contribuições de valores elevados quando comparamos os quartils dos valores com e sem estas contribuições, para cada candidato.

```{r echo=FALSE}
# plotbox com e sem contribuições com valores superiores a R$ 100.000,00
ggplot(aes(y=contb_receipt_amt, x=cand_nm), 
       data = USACampaign)+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(y=contb_receipt_amt, x=cand_nm), 
       data = subset(USACampaign, 
                     contbr_nm != "HILLARY VICTORY FUND - UNITEMIZED"))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Esta discrepancia prejudicaria a avaliação das contribuições entre os candidatos e restringiria as analises dos dados. Desta forma optei por fazer a analise das contribuições feitas pelos eleitores do estado do TX, que traz uma distribuição mais homogenea nas contribuições.

***

## Analise do dataset do estado do Texas

Inicamos aqui a análise do dataset do estado do Texas (TX). Algumas verificações simples nesta base de dados nos aponta necessidade de tratamento das informações. Este tratamento será feito em um script a parte, em python [`tratarDados.py`](tratarDados.py). Maiores detalhes sobre este tratamentos pode ser visualizado no arquivo [`Tratamento de dados.md`](Tratamento de dados.md). 

```{r Carga dos dados de contribuição do TX sem tratamento, echo  = FALSE}
USACampaign <- read.csv('P00000001-TX.csv', header = T, as.is = T)

# Verifica quantidade de registros com valores de contribuição negativa
dim(USACampaign[USACampaign$contb_receipt_amt < 0,])

# Verifica quantidade de registros com valores de contribuição igual a 0 (zero)
dim(USACampaign[USACampaign$contb_receipt_amt == 0,])

# Verifica a existencia de regitro diferentes para a mesma cidade, escritas 
#de formas diferentes
table(USACampaign[substr(USACampaign$contbr_city, 1, 4) == "DALL",]$contbr_city)

```

```{r Carregar dados e resumo, echo=FALSE}
# Carregamento dos dados
USACampaign <- read.csv('P00000001-TX_tratado.csv', header = T, as.is = T)

max(USACampaign[USACampaign$contb_receipt_amt < 100000,]$contb_receipt_amt)

USACampaign$cmte_id <- as.factor(USACampaign$cmte_id)
USACampaign$cand_id <- as.factor(USACampaign$cand_id)
USACampaign$cand_nm <- as.factor(USACampaign$cand_nm)
USACampaign$contbr_occupation <- as.factor(USACampaign$contbr_occupation)
summary(USACampaign$contbr_occupation)

USACampaign$contb_receipt_dt <- as.Date(USACampaign$contb_receipt_dt, 
                                        "%d-%b-%y")
USACampaign$contb_receipt_dt_month <- as.Date(USACampaign$contb_receipt_dt_month, 
                                              "%d-%b-%y")
summary(USACampaign$contb_receipt_date)

#Detalhes do dataset
dim(USACampaign)
names(USACampaign)
str(USACampaign)
summary(USACampaign)

```


```{r Funcoes genéricas, echo=FALSE, warning=FALSE}

# Função para recuperar listar ordenadas pelo nome campo.
# Esta função permite definir quantidade de registros e o tipo de ordenação:
# - Por quantidade de doações (qtde)
# - Por total de doações (total)
# - Pela média de doações (media)
lista_ordenada <- function(campo, quantidade = NULL, ordenado_por = "total") {
  result <- USACampaign %>%
      group_by(.dots = c(campo)) %>%
      summarise(qtde = n(),
                total = sum(contb_receipt_amt),
                media = mean(contb_receipt_amt))
  result <- arrange(result, desc(result[[ordenado_por]]))
  if (!is.null(quantidade)) {
    head(result, quantidade)
  } else {
    result
  }
}


USACampaign$cand_nm <- factor(USACampaign$cand_nm, 
                              lista_ordenada("cand_nm", 
                                             ordenado_por = "qtde")$cand_nm)

```
O dataset tratado contem 548.396 observações com 29 variaveis. O dataset original (sem tratamento) contém 18 variáveis.

# Seção de Gráficos Univariados

É importante realizarmos uma analise sobre a distribuição das contribuições entre os candidatos. Nesta analise já classifiquei os candidatos por partido para identificação, com o intuíto de entender melhor como é a divisão entre as legendas. Para a difinição do partido, consideramos a classificação registrada na base de dados de candidatos obtida no site da [**FEC**](https://cg-519a459a-0ea3-42c2-b7bc-fa1143481f74.s3-us-gov-west-1.amazonaws.com/bulk-downloads/2016/cn16.zip). 

Nesta análise percebemos que a maior quantidade de doações se concentram nos 4 primeiros candidatos, mas é importante notar que quando ordenamos por valor total arrecadado, existe um inversão nas posições. Devido a essa inversão farei uma análise focada nos 7 candidatos com maior volume arrecada, no lugar de 5 candidatos que era a idéia inicial.

Uma analise mais detalhada desse aspecto será realizada na seção de gráficos bivariados.

```{r Distribuição por candidato, echo = FALSE}
hist_cand_ordenado <- function(campo, cond = NULL, titulo) {
    
  USACampaign$cand_nm <- factor(USACampaign$cand_nm, 
                                lista_ordenada("cand_nm", 
                                               ordenado_por = campo)$cand_nm)

  if (is.null(cond)) {
    df = USACampaign
  } else {
    df = subset(USACampaign, cand_nm %in% cond)
  }
  
  ggplot(aes(x = cand_nm), 
         data = df)+
    geom_bar(stat = 'count')+
    xlab("Candidatos")+
    ylab("Qtde de contribuições")+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))+
    ggtitle(titulo)

}

#Histograma ordenado por qtde
hist_cand_ordenado("qtde", 
            titulo = "Histograma das contribuições (ordenados por quantidade)")

#Histograma ordenado por valor total
hist_cand_ordenado("total", 
            titulo = "Histograma das contribuições (ordenados por valor total)")

top7_cand <- as.ordered(lista_ordenada("cand_nm", 
                                       ordenado_por = "qtde", 
                                       quantidade =  7)$cand_nm)
hist_cand_ordenado("qtde", top7_cand, 
            titulo = "Histograma das contribuições (Top 7)")

ggplot(aes(y=contb_receipt_amt, x=cand_nm), 
       data = subset(USACampaign, cand_nm %in% top7_cand), outline = FALSE)+
  geom_boxplot()+
  ylim(0,500)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

Como esperado, nota-se que a maior parte das contribuições se destinam aos candidatos democratas (DEM) e republicanos (REP), desta forma vamos considerar apenas estes 2 partidos nas analises. É importante percebermos pelo **Boxplot** que a as contribuições para os candidatos republicanos, no geral, possuem um valor unitário maior que as doações feitas aos democratas. Isto deve trazer um impacto no valor total arrecadado por partido, apesar de ambos possuirem quantidades de contribuições semelhantes. Esta é uma analise a ser feita na seção de Gráficos Bivariados.  

```{r Distribuição das contribuições por partido, echo = FALSE}

USACampaign.rep_and_dem <- subset(USACampaign, party %in% c("DEM","REP")) 

ggplot(aes(x=party), 
       data = USACampaign.rep_and_dem)+
  geom_bar(stat = 'count')

#Boxplot com outline
boxplot(contb_receipt_amt ~ party, data = USACampaign.rep_and_dem)

#Boxplot sem outline
boxplot(contb_receipt_amt ~ party, 
        data = USACampaign.rep_and_dem, outline=FALSE)

```

Na analise a seguir procurei fazer uma avaliação identificando como foram realizadas as contribuições ao longo do período. Iniciei a analise verificando a distribuição das doações por ano e, em seguida, realizei a analise por mês.

Por fim, foquei no periodo de 2016, que é onde ocorreram a maior quantidade de doações.


```{r Distribuição das doações ao longo do periodo, echo=FALSE, warning=FALSE}
summary(USACampaign$contb_receipt_dt)

ggplot(aes(y = contb_receipt_dt_month, x = contbr_st), data = USACampaign)+
  geom_boxplot()+
  scale_y_date(date_breaks = "2 months")

ggplot(aes(x = contb_receipt_dt_year), data = USACampaign)+
  geom_histogram(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições por ano')

ggplot(aes(x = contb_receipt_dt_month), data = USACampaign)+
  geom_histogram(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(date_breaks = "2 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y")+
  ggtitle('Distribuição das contribuições por mes')

#Freqpoly das contribuições em todo periodo considerando um binwidth 
#de 7 (1 semana)
g <- ggplot(aes(x = contb_receipt_dt), data = USACampaign)+
  geom_freqpoly(binwidth=7)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g+
  scale_x_date(date_breaks = "3 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2013-10-01", "2016-12-31")))+
  ggtitle('Distribuição das contribuições no período')

#Freqpoly das contribuições no ano de 2016 considerando um binwidth 
#de 7 (1 semana)
g+
  scale_x_date(date_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2016-01-01", "2016-12-31")))+
  ggtitle('Distribuição das contribuições no período em 2016')

```

Na sequencia analisei a distribuição das doações por quantidade. Nesta analiíse foi possível perceber como as contribuições de menores valores são as mais frequentes. Esse já era um comportamento esperado um vez que muitos eleitores não possuem muitos recursos para doar mas procuram ajudar com uma quantidade que esta ao seu alcance.

```{r Distribuição das contribuições por valor, echo = FALSE, warning=FALSE}

ggplot(aes(x=contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(binwidth = 100)+
  scale_x_continuous(breaks = seq(0, 15000, 2500))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Para uma analise de um espectro maior de valores, reduzi o binwidth em 10x. Na sequência reduzi o limite do eixo x com o objetivo de focar nos valores de contribuições mais frequentes, chegando no limite de um quartil de 95%. Por fim, apliqei uma escala logaritima para exibir melhor o valores com menos doações.

```{r Distribuição das contribuições por valor 2, echo = FALSE, warning=FALSE}
g <- ggplot(aes(x=contb_receipt_amt), 
       data = USACampaign)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Exibe o primeiro grafico
g +
  geom_histogram(binwidth = 10)+
  scale_x_continuous(breaks = seq(0, 15000, 2500))

summary(USACampaign$contb_receipt_amt)

#Removendo os outliers
quantile(USACampaign$contb_receipt_amt, 0.95)

ggplot(aes(x = contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(binwidth = 1)+
  scale_x_continuous(limits = c(0, 
                                quantile(USACampaign$contb_receipt_amt, 0.95)), 
                     breaks = seq(0, 
                                  quantile(USACampaign$contb_receipt_amt, 0.95), 
                                  50))+
  scale_y_log10(breaks=c(10, 100, 1000, 10000, 100000))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Aplica a escala logaritimica no eixo y ,no grafico anterior
g +
  geom_histogram(bins = 25)+
  scale_x_log10()
#  scale_y_log10(breaks=c(10, 100, 1000, 10000, 100000))
  

```

Abaixo uma comparação entre a quantidade de doações entre as eleições primárias (P2016) e gerais (G2016). Nela vemos que as primárias tiveram mais do dobra de contribuições. Isso pode ser explicado pelo fato de termos mais candidatos, além de um tempo maior para doações.

```{r echo=FALSE, warning=FALSE}
ggplot(aes(x = election_tp), 
       data = subset(USACampaign, election_tp %in% c("G2016", "P2016")))+
  geom_bar(stat = 'count')+
  scale_y_continuous(breaks=seq(0, 4e5, 50000))
```

Para uma melhor visualização de como a quantidade de doações é inversamente proporcional ao valor, decidi classificar os valores de contribuição considerando as seguintes faixas de valores:

- Até 100,00
- 100,01 a 500,00
- 500,01 a 2.700,00
- Acima de 2.700,00

Esta classificação também vai nos ajudar a conhecer melhor as características das doações para cada candidato.

O valor de 2.700 foi escolhido por este ser o limite de doações por contribuinte, por etapa da eleição.

```{r echo=FALSE, warning=FALSE}
# Cria faixa para os valores de contribuição
USACampaign$contb_receipt_amt_range <- cut(USACampaign$contb_receipt_amt, 
                                           c(0, 100, 500, 2700, 
                                            max(USACampaign$contb_receipt_amt)))

ggplot(aes(x=contb_receipt_amt_range), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  scale_y_continuous(breaks=seq(0, 600000, 50000))+
  scale_x_discrete(labels=c("Até 100", "100-500", "500-2700", "Acima de 2700"))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

Para uma analise com base nas cidades, decidi aplicar um filtro inicial uma vez que existem cerca de 1300 cidades diferentes registradas. Desta forma decidi gerar o histograma apenas para as 30 cidades com maior número de contriuições.

Nesta analise percebemos que as principais cidades do estado então entre aquelas com mais números de contribuição, o que não surpreende já que se espera uma relação direta entre a quantidade de doações e a população.

```{r Distribuição das contribuições na 30 maiores cidades, echo = FALSE, warning = FALSE}
# Ordena as cidades com base na quantidade de contribuições
USACampaign$city_ordered <- factor(USACampaign$city, 
                                   lista_ordenada("city", 
                                                  ordenado_por = "qtde")$city)

# Distribuição das contribuições entre as cidades com mais contribuições
ggplot(aes(x=city_ordered), 
       data = subset(USACampaign, 
                     city %in% lista_ordenada("city", 30, 
                                              ordenado_por = "qtde")$city))+
  geom_bar(stat = 'count')+
  scale_y_continuous(breaks=seq(0, 70000, 10000), 
                     minor_breaks = seq(0, 75000, 2500))+
  xlab("Cidades do estado do TX")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Análise Univariada

### Qual é a estrutura do conjunto de dados?

O conjunto de dados possui 548372 registros de contribuições para o estado de TX, com 29 atributos no arquivo tratado e 18 no arquivo original.

### Quais são os principais atributos de interesse deste conjunto de dados?

A minha intenção neste trabalho é analisar como foi a distribuição de doações para os candidatos. Para esta análise, as principais atributos deste conjunto de dados são os candidatos (*cand_nm*), os valores das contribuições (*contb_receipt_amt* e *contb_receipt_amt_range*) e a data de contribuição (*contb_receipt_dt*, *contb_receipt_dt_month* e *contb_receipt_dt_year*).

### Quais outros atributos você acha que podem lhe auxiliar na investigação destes atributos de interesse?

Atributos realcionados a origem das contribuições serão muito úteis nesta analise. Entre elas estão:

- Partido
- Nome do comite
- Profisssão do contribuinte
- Cidade do contribuinte
- Tipo de eleição (primárias ou gerais)

### Você criou novas variáveis a partir dos atributos existentes no conjunto de dados?

Sim. Foram criados as seguintes variaveis: 

- A partir da data, criei colunas com os componentes da data de contribuição (mês e ano)
- Foram incorporados dados do dataset de CEP (zipcode): cidade, longitude e latitude 
- Foi adicionada uma coluna com faixas dos valores doados.
- A partir da base de dados dos candidatos (obtido na FEC), foi incorporado o partido do candidato
- A partir da base de dados dos comites (obtido na FEC), foi incorporado o nome do comite

### Dos atributos investigados, distribuições incomuns foram encontradas? Você aplicou operações nos dados para limpá-los, ajustá-los ou mudar a forma dos dados? Se sim, por quê?

Foram realizados tratamentos nos valores de contribuição. Para os valores negativos, foi considerado o valor absoluto. As contribuições zeradas foram eliminadas.

As datas de contribuição carregadas originalmente como `caracter`, foram convertidas para `Date` e quebrada em colunas separadas para mes e ano.

Conforme apresentado na seção de tratamento de dados, fiz uma ajuste nos nomes das cidades para eleminar as cidades iguais registradas com grafias diferentes. O mesmo tratamento foi realizado para a ocupação dos contribuintes.

Foi feito também um tratamento para os tipos de eleição inválidos.

Todos os tratamentos foram realizados num script python a parte [`tratarDados.py`](tratarDados.py).

# Seção de Gráficos Bivariados

Aqui fiz uma analise das distriuição dos valores ao longo do tempo. No primeiro gráfico foi feita uma analise mais ampla por todo o período compreendido no dataset. No segundo reduzi o faixa de valores para o ano de 2016 e foi considerada as contribuições realizadas dentro de 99% da amostragem.

Nesta analise percebemos que os valores doados se iniciaram principalmente no 2º trimestre de 2015 com um média ligeiramente maior, reduzindo a partir de agosto de 2015 e se mantendo com pouca variação até o final de 2016.

Já o valor máximo das contribuições tem uma redução a partir de maio/2016.

Foram demarcados 3 indicadores de valores para este gráfico:

- Faixa de $2.700, relativo ao valor máximo permitido por contribuinte (linha preta pontilhada)
- Valor máximo de contribuição por mês (linha azul pontilhada)
- Valor médio de contribuição por mês (linha verde pontilhada)

```{r Valores de contrbuição ao longo do tempo, echo = FALSE, warning= FALSE}

g <- ggplot(aes(x = contb_receipt_dt_month, y = contb_receipt_amt), 
       data = USACampaign)+
  geom_point(alpha = 1/100, position = 'jitter', color = 'orange')+
  geom_line(stat = 'summary', fun.y = mean, color = 'green', linetype = 3)+
  geom_hline(yintercept = 2700, linetype = 3)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período')

g+
  scale_x_date(date_breaks = "2 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y")+
  scale_y_continuous(breaks = seq(0, 17500, 1000))+
  geom_line(stat = 'summary', fun.y = max, color = 'blue', linetype = 3)

g+
  scale_x_date(date_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2015-01-01","2016-12-31")))+
  scale_y_continuous(breaks = seq(0, 6000, 500), 
                  limits = c(0, quantile(USACampaign$contb_receipt_amt, 0.99)))
```

Na sequencia avaliei o valor total e a média e mediana dos valores de contribuições no tempo.

```{r}
#Criei uma estrtura base do gráfico para, na sequencia, adicionar os layers 
#especificos de cada gráfico
g <- ggplot(aes(x = contb_receipt_dt_month, y = contb_receipt_amt), 
       data = USACampaign)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(date_breaks = "2 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y")

g+ 
  geom_line(stat = 'summary', fun.y = sum, color = 'blue')+
  ggtitle('Valor total das contribuições no período')

g+
  geom_line(stat = 'summary', fun.y = mean, color = 'red')+
  geom_line(stat = 'summary', fun.y = median, color = 'orange')+
  ggtitle('Evolução das médias é medianas das contribuições no período')
```

Nos primeiros gráficos desta seção podemos perceber a presença de faixas horizontais bem definidas para os valores doados com mais frequncias. Estes normalmente são valores arredondados Uma faixa bem definida é a 2700 dolares, que era o limite máximo permitido para pessoas físicas ([Limites de contribuições - FEC](https://transition.fec.gov/info/contriblimitschart1516.pdf)). Considerando eleições primárias e geral, é possível uma doação de $5.400,00 (2.700 para cada). 

Apesar destas regras, é possível se notar valores de doações acima este limite, necessitando uma pesquisa para entender as regras de contribuições. Grande parte dessas doações se destinam a Ted Cruz como podemos ver nas analises abaixo.

```{r echo=FALSE}
table(USACampaign[USACampaign$contb_receipt_amt > 5400,]$cand_nm)

length(USACampaign[USACampaign$contb_receipt_amt > 5400,]$cand_nm)

ggplot(aes(y = contb_receipt_amt, fill = cand_nm, x = ""), 
       data=USACampaign[USACampaign$contb_receipt_amt > 5400,])+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start = 0)
```

Estas mesmas faixas podem ser percebidas quando analisamos a os valores de contribuição por candidato, como visto abaixo. Percebe-se também, como já visto no histograma por faixa de valor doado, que a maioria das contribuições estão abaixo de U$ 500,00.

```{r Valor de contibuições para cada candidato, echo=FALSE, warning=FALSE}
#Base para grafico de dispersao dos candidatos
g <- ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point(alpha = 1/50, position = 'jitter')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

g+scale_y_continuous(breaks = seq(0, 20000, 1000))

# Grafico com limite no eixo y para 3000 dolares.
g+scale_y_continuous(breaks = seq(0, 3000, 250),
  limits = c(0, quantile(USACampaign$contb_receipt_amt, 0.99)))

```

Abaixo temos o comportamente das doações ao longo do tempo para os 7 principais candiatos. Aqui é muito interessante como estão distribuidas as contribuições para os candidatos republicanos. Trump quase não possuia doações nas primárias e passou a ser o destino de grande parte das contribuições republicanas nas eleições gerais após Ted Cruz sair da disputa.

```{r echo=FALSE, warning=FALSE}
ggplot(aes(y = cand_nm, x = contb_receipt_dt_month), 
       data=subset(USACampaign, 
                   cand_nm %in% top7_cand & 
                     election_tp %in% c("P2016", "G2016")))+
  geom_point(alpha = 1/100, position = 'jitter')+
  geom_vline(xintercept = as.Date("2016-05-01"), linetype = 3, color = 'red')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(date_breaks = "2 months", 
               date_labels = "%b/%Y")


ggplot(aes(x = cand_nm, fill = election_tp), 
       data=subset(USACampaign, 
                   cand_nm %in% lista_ordenada("cand_nm", 3, 
                                              ordenado_por = "total")$cand_nm))+
  geom_bar(stat = 'count')
```

Nesta sequencia de gráficos vemos as relações entre os 7 candidatos citados anteiormente e os valores de contribuição. Ao contrário do que normalmente seria esperado, o candidato com mais contribuições não é o mesmo com maior valor arrecadado. O candidato **Jeb Bush**, apesar de possuir menos de 5% das contribuições de **Bernard Sanders**, conseguiu arrecadar um pouco que este ultimo. No caso especial de Jeb Bush, isto pode ter relação com o fato do Texas ser o seu estado Natal, além da sua  relação com os outros 2 ex-presidentes Bush (pai e irmão).

```{r Valor médio das contribuições, echo=FALSE}

plot_candidato <- function(df, campo, titulo = '') {
  ggplot(aes(x = cand_nm, y = campo), data = df)+
    geom_bar(stat = 'identity', fill = I('#99AAFF'))+
    ggtitle(titulo)+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

df <- lista_ordenada("cand_nm", 7, ordenado_por = "qtde")

df

plot_candidato(df, df$qtde, 'Qtde de contribuições por candidato')
plot_candidato(df, df$total, 'Valor total por candidato')
plot_candidato(df, df$media, 'Valor médio por candidato')


```

Um comportamento semelhante pode ser observado quando analisamos os 2 principais partidos (Democratas e Republicanos). Embora os democratas tenham uma quantidade de contribuições maior do que a dos republicanos (feitas principalmente em nome de Hillary Cinton), o valor arreacadado do segundo é quase o dobro do primeiro, corroborando com a analise feita na seção anterior, a partir dos boxplot.

```{r Distribuição das contribuições por partido e candidato, echo = FALSE}

ggplot(aes(x=party), 
       data = USACampaign.rep_and_dem)+
  geom_bar(stat = 'count')+
  scale_y_continuous(breaks = seq(0, 300000, 25000))+
  xlab("Partidos")+
  ylab("Quantidade de contribuições")+
  ggtitle('Distribuição das contribuições por partido')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position="bottom")


ggplot(aes(x=party, y=contb_receipt_amt), 
       data = USACampaign.rep_and_dem)+
  geom_bar(stat = 'summary', fun.y = sum)+
  xlab("Partidos")+
  ylab("Valor total das contribuições")+
  ggtitle('Valor total do financiamento por partido')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position="bottom")
```

No entanto analisando pelo tipo de eleição, percebe-se que o valor total doado para cada tipo segue a tendencia do histograma apresentado na primeira seção. 

```{r echo=FALSE}
ggplot(aes(x = election_tp, y = contb_receipt_amt), 
       data = USACampaign.rep_and_dem)+
  geom_bar(stat = 'summary', fun.y = sum)+
  xlab("Eleição")+
  ylab("Valor total das contribuições")+
  ggtitle('Valor total do financiamento por tipo de eleição')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position="bottom")

```

Na distribuição das doações entre as cidades do estado do TX, temos Austin em segundo, atrás apenas da cidade de Houston, porém quando analisamos o valor total, Dallas vem em segundo, deixando Austin em terceiro. Isto poderia estar relacionada a renda media de cada cidade mas sem os dados de renda média por município, não é possível uma analise mais apurada.

Na análise dos quartis dos valores por municipio, temos uma situação bem interessante, onde a maioris das cidades possui um valor de U$ 50 em seu 3º quartil.

```{r Distribuição das contribuições na 30 maiores cidades por partido, echo = FALSE, warning = FALSE}

USACampaign$city <- factor(USACampaign$city, lista_ordenada("city")$city)
top30_city <- lista_ordenada("city", 30, ordenado_por = "qtde")$city

# Distribuição das contribuições entre as cidades com mais contribuições 
#por partido
ggplot(aes(x = city, fill = party), 
       data = subset(USACampaign, city %in% top30_city))+
  geom_bar(stat = 'count')+
  scale_y_continuous(breaks = seq(0, 70000, 10000), 
                     minor_breaks = seq(0, 75000, 2500))+
  xlab("Cidades do estado do TX")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=city, y=contb_receipt_amt, fill = party), 
       data = subset(USACampaign, city %in% top30_city))+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  scale_y_continuous(breaks = seq(0, 70000, 10000), 
                     minor_breaks = seq(0, 75000, 2500))+
  xlab("Cidades do estado do TX")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Distribuição dos valores para os principais municipios
ggplot(aes(x=city, y=contb_receipt_amt), 
       data = subset(USACampaign, city %in% top30_city))+
  geom_boxplot()+
  geom_hline(yintercept = 50, linetype = 2, color = 'red')+
  scale_y_continuous(breaks=seq(0, 120, 10), limits = c(0, 120))+
  xlab("Cidades do estado do TX")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Por fim fiz uma analise da distribuição geográfica das doações com base nas informações de longitude (`lon`) e latitude (`lat`) recolhidas na base de dados de zipcode.

Como esperado, a maioria das doação estão concentradas na parte leste do estado, onde se localizam as cidades com maior quantidade de contribuições: Houston, Austin, Dallas e San Antonio.

```{r Distribuição espacial das distribuições no estado do Texas, echo=FALSE, warning=FALSE}

#Distribuição espacial das contribuições no estado do TX
ia <- map_data("county", "texas")
ggplot(ia, aes(long, lat)) +
  geom_polygon(aes(group = group), fill = NA, colour = "grey60") +
  geom_point(aes(lon, lat), data = USACampaign, alpha = 0.05)+
  ylim(25, 37)+
  xlim(-110, -90)


```

# Análise Bivariada

### Discuta sobre alguns dos relacionamentos observados nesta parte da investigação. Como os atributos de interesse variaram no conjunto de dados?

#### Contribuição no tempo

A partir da analise com base em duas variáveis, notamos que embora exista uma tendencia de crescimento de doações ao longo do tempo, o mesmo não acontece com o valor total recebido, apresentando um comportamento variavel, sem uma tendencia.

Outra variação notada é a de redução do valor máximo das contribuição a partir de maio/2017. Acredito que essa redução se deva a alguma regulamentação para as eleições gerais mas não consegui encontrar dados que me comprovassem essa teoria.

#### Contribuição por candidato

Ao fazermos uma análise mais detalhada por candidato, notamos que o candidato Ted Cruz possui muitas doações acima de U$ 5.400 (199 contra 11 para os demais candidatos). Essas doações elevaram bastante o valor médio de suas doações fazendo com que fosse o candidato com a maior arrecadação, embora Hillary Clinton tivesse muito mais doações a seu favor. Essa maioria se deve ao fato de Clinton ter disputado as prévias e gerais. Quando analisamos apenas as prévias, Ted Cruz foi o candidato com mais doações.

Na distribuição dos valores por candidato, vemos claramente como existe um migração das doações dos republicanos para Donald Trump ao fim das primárias. Ted Cruz foi o candidato preferido do estado e destino da maioria das doações nas primárias, mas com a vitória de Trump dentro do partido republicano, muitas doações passaram a ter Trump como beneficiado.

### Você observou algum relacionamento interessante entre os outros atributos (os que não são de interesse)?

Uma observação interessante foi em relação ao boxplot dos valores por municípios. Na grande das 30 cidades com mais contribuições, o 3º quartil possui um valor de U$ 50. Considerando o tamanho da base e diversidades de valores possíveis para doação, essa é uma situação bem incomum.

### Qual foi o relacionamento mais forte encontrado?

Com base nas análises, não consegui identificar nenhum relacionamento forte em entre as variáveis analisadas. Parece haver uma relação entre o tamanho dos municípios e a quantidade de doações, no entanto, sem informações de população não é possível fazer esta analise.

# Seção de Gráficos Multivariados

No primeiro gráfico adicinamos a váriavel de cor ao gráfico apresentado na seção anterior para identificar as doações referente as primárias e as gerais. Nele fica ainda mais claro a mudança do destino das doaçoes republicanas para Donald Trump.

```{r echo=FALSE, warning=FALSE}
ggplot(aes(y = cand_nm, x = contb_receipt_dt_month, color = election_tp), 
       data=subset(USACampaign, cand_nm %in% top7_cand))+
  geom_point(alpha = 1/100, position = 'jitter')+
  geom_vline(xintercept = as.Date("2016-05-01"), linetype = 3, color = 'red')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  scale_x_date(date_breaks = "4 months", 
               date_labels = "%b/%Y")+
  facet_wrap(~party)
```

No gráfico abaixo analisei o total de doações por mês e partido, destacando os valores de contribuição nas faixas definidas. Focamos nos partidos democrata e republicano e nos anos de 2015 e 2016 por serem os responsáveis pela maioria dos dados.

Podemos perceber como os candidatos democratas tiveram um valor de doação bem superior ao dos candidatos democratas. Em parte, isso se deve ao maior numero de contribuições na faixa mais alta de doações. Vemos que os democratas quase não tiveram doações acima de 2700 reais (apenas 17 contra 1765 dos republicanos)

Uma outra observação importante é da diferença de valores recebidos em 2015. Isso se deve principalmenteas doações recebidas pelo candidato Ted Cruz. Entre os republicanos é possível notar que as principais doações no segundo semestre de 2016 se destinaram a Donald Trump. Esta mudança no destino das doações ocorre após o final das primárias no estado do Texas, umas vez que Ted Cruz, vencedor no estado, não se manteve na disputa da vaga para presidente. 

Entre os democratas, nota-se que a maior parte das doação se destinaram a Hillary Clinton.

Ted Cruz e Jeb Bush tiveram um apoio considerável em 2015 com as doações dos texanos. Isto se deve principalmente do Texas ser o estado onde Cruz é senador e o estado natal de Jeb Bush.

```{r echo=FALSE, warning = FALSE}

ggplot(aes(x = contb_receipt_dt_month, y = contb_receipt_amt, 
           fill = contb_receipt_amt_range), 
       data = subset(USACampaign, party %in% c("DEM", "REP") & 
                       contb_receipt_dt_year %in% c("15", "16")))+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom")+
  xlab("Data")+
  ylab("Total doado")+
  labs(fill = "Faixa de valor")+
  facet_wrap(~party)

ggplot(aes(x = contb_receipt_dt_month, y = contb_receipt_amt, fill  =cand_nm), 
       data = subset(USACampaign, party %in% c("DEM", "REP") & 
                       contb_receipt_dt_year %in% c("15", "16")))+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  geom_vline(xintercept = as.Date("2016-03-01"), linetype = 3)+
  geom_vline(xintercept = as.Date("2016-05-24"), linetype = 3)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom")+
  xlab("Data")+
  ylab("Total doado")+
  facet_wrap(~party)


table(USACampaign$party, USACampaign$contb_receipt_amt_range)
```

No gráfico seguinte, notamos que a maior parte doações acima de 2700 foram no ano de 2015 enquanto as doações de menores valores ocorreram principamente em 2016, o que explica o comportamente citados anteriormente.

```{r echo=FALSE, warning=FALSE}
ggplot(aes(y = contb_receipt_amt, x = contb_receipt_dt_month, 
           color = contb_receipt_amt_range),
       data = subset(USACampaign, 
                     lubridate::year(contb_receipt_dt_month) >= 2015 &
                       party %in% c("DEM","REP")))+
  geom_line(stat = 'summary', fun.y = sum)+
  scale_y_continuous(breaks = seq(0, 4e6, 5e5))+
  scale_x_date(date_breaks = "2 months", 
               date_labels = "%b/%Y")+
  ylab('Valor total das doações')+
  xlab('Mês')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom" )+
  ggtitle('Faixa dos valores doados por partido, ao longo dos anos de 2015 e 2016')+
  facet_wrap(~party)
```

Por fim fiz uma análise das faixas de contribuição ao longo do tempo para os 2 candidatos que disputaram a presidencia em 2016. Nele fica claro mais uma vez o aumento de contribuições para **Donald Trump** após as primárias. Também vemos um crescimento das contribuições de menor valor para Hillary Clinton (até U$ 500).

```{r echo=FALSE, warning=FALSE}
ggplot(aes(y = contb_receipt_amt, x = contb_receipt_dt_month, color = cand_nm), 
       data = subset(USACampaign, cand_nm %in% c("Clinton, Hillary Rodham",
                                                 "Trump, Donald J.")))+
  geom_line(stat = 'summary', fun.y = sum)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom" )+
  facet_wrap(~contb_receipt_amt_range)
```


# Análise Multivariada

### Discuta sobre os relacionamentos observados nesta parte da investigação. Quais atributos que fortaleceram os demais na observação das variáveis de interesse?

Um dos atributos derivados que foi de grande importancia na analise foi o relacionado a faixa de valores doados (`contb_receipt_amt_range`). Com ele foi possível entender melhor o comportanto das doações para os candidatos e partidos ao logo do período avaliado. 

Outra observação foi em relação as doações no período. Pelas analises conseguimos notar claramente o comportamento do contribuintes para as primárias e as gerais. A separação das datas por mês permitiu uma analise mais homogenia no periodo.

### Interações surpreendentes e/ou interessantes foram encontradas entre os atributos?

Como citado anteriormente, uma das interações que foram contra minha intuição era a de que o valor total das contribuições fosse diretamente relacionada a quantidade de doações. Em várias analises percemos a influencia do valor médio de contribuição. Em diversos classificações realizadas percebemos que haviam situações em que doações em menores quantidades geravam um maior valor recebido, devido ao valor unitário de cada uma das contribuições.

Um outro interação interessante foi a mudança das contribuições republicanas de Ted Cruz para Trump ao fim das primárias. Ted Cruz era o candidato preferido do estado e foi o principal beneficiário das doações. Com Cruz fora da disputa, as contrinuições dos eleitores do partido migraram para Trump. 

------

# Gráficos Finais e Sumário

### Primeiro Gráfico
```{r Plot_One, echo=FALSE, warning=FALSE}

top3_cand_total <- lista_ordenada("cand_nm", 3, ordenado_por = "total")$cand_nm

ggplot(aes(x = contb_receipt_dt_month, y = contb_receipt_amt, 
           fill = contb_receipt_amt_range), 
       data = subset(USACampaign, 
                     cand_nm %in% top3_cand_total & 
                       contb_receipt_dt_year %in% c("15", "16")))+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "bottom")+
  scale_y_continuous(breaks = seq(0, 4e6, 5e5))+
  scale_x_date(date_breaks = "4 months", 
               date_minor_breaks = "2 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2015-01-01", "2016-12-31")))+
  scale_fill_discrete(labels=c("Até $100", 
                               "$100,01 a $500", 
                               "$500,01 a $2.700",
                               "Acima de $2.700"))+
  xlab("Data")+
  ylab("Valor total de doações")+
  labs(fill = "Faixa de valor")+
  facet_wrap(~cand_nm)+
  ggtitle('Valor total de doações ao longo do tempo, por candidato e faixa de valores')


ggplot(aes(x = contb_receipt_dt, fill = contb_receipt_amt_range), 
       data=subset(USACampaign, 
                   cand_nm %in% top3_cand_total & !is.na(contb_receipt_amt)))+
  geom_histogram()+
  geom_vline(xintercept =  as.Date("2016-03-01"), linetype = 2)+
  geom_vline(xintercept =  as.Date("2016-05-24"), linetype = 2, color = 'red')+
  scale_x_date(date_breaks = "4 months", 
               date_minor_breaks = "2 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2015-01-01", "2016-12-31")))+
  scale_fill_discrete(labels=c("Até $100", 
                               "$100,01 a $500", 
                               "$500,01 a $2.700",
                               "Acima de $2.700"))+
  xlab("Data")+
  ylab("Quantidade de doações")+
  labs(fill = "Faixa de valor")+
  facet_wrap(~cand_nm, ncol = 3)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position="bottom")+
  ggtitle('Quantidade de doações ao longo do tempo, por candidato')

```

### Descrição do Primeiro Gráfico

O primeiro gráfico foca na distribuição de doações para os 3 candidatos com maior valor recebido em doações. Esta escolha foi feita considerando que entre estes candidatos está o escolhido nas primárias do Texas (Ted Cruz) e os dois candidatos que disputaram a presidência dos EUA em 2016 (Hillary Clinton e Donald Trump).

Esta analise se baseia no valor arrecadado ao longo do período de doação para cada candidato. Nele podemos notar algumas características interesantes após o fim das primárias.

O primeiro é a mudança das doações dos eleitores republicanos de Cruz para Trump. Isso se explica pelo fato que Ted Cruz era o candidato preferido no estado, justficando o enorme volume doado a ele para as primárias e, com a sua saída da disputa, as doações republicana se voltaram para Donald Trump.

O segundo fator é o grande aumento na quantidade de doações a Hillary Clinton na a eleição final. Esse comportamento poderia ser explicado por alguns fatoeres como a efeito "anti Trump" e a reta final da corrida pela presidencia americana.

Quando analisamos os valores em um grafico de barra, vemos facilmente a influencia das doações de maiores valores no montante total arrecadado por Ted Cruz.

### Segundo Gráfico
```{r echo=FALSE, Plot_Two}

df <- USACampaign %>%
  group_by(party, contb_receipt_dt_month) %>%
  summarise(qtde = n(), 
            total = sum(contb_receipt_amt)) 

ggplot(aes(y = total, x = contb_receipt_dt_month, color = party),
       data = subset(df, lubridate::year(contb_receipt_dt_month) >= 2015))+
  geom_line(linetype = 3)+
  geom_point(aes(size = qtde), pch = 16)+
  scale_y_continuous(breaks = seq(0, 6e6, 5e5))+
  scale_x_date(date_breaks = "2 months", 
               date_labels = "%b/%Y")+
  ylab('Valor total das doações')+
  xlab('Mês')+
  labs(size = "Quantidade", color = "Partido")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Valor total vs Quantidade por partido, ao longo dos anos de 2015 e 2016')

#Analise de valores vs quantidade para o primeiro trimestre de 2016
with(subset(df, 
            contb_receipt_dt_month >= as.Date("2016-01-01") & 
            contb_receipt_dt_month <= as.Date("2016-03-31") ), 
     by(qtde/sum(qtde), party, sum))

with(subset(df, 
            contb_receipt_dt_month >= as.Date("2016-01-01") & 
            contb_receipt_dt_month <= as.Date("2016-03-31") ), 
     by(total/sum(total), party, sum))

#Analise de valores vs quantidade para o out/2016
with(subset(df, 
            contb_receipt_dt_month >= as.Date("2016-10-01") & 
            contb_receipt_dt_month <= as.Date("2016-10-31") ), 
     by(qtde/sum(qtde), party, sum))

with(subset(df, 
            contb_receipt_dt_month >= as.Date("2016-10-01") & 
            contb_receipt_dt_month <= as.Date("2016-10-31") ), 
     by(total/sum(total), party, sum))


```

### Descrição do Segundo Gráfico

Neste gráfico procurei analisar o valor total de doações comparado a quantidade para os partidos. Nele fica claro a diferença no valor total de contribuições entre os partidos no ano de 2015 e inicio de 2016. Vemos que nos primeiros meses de 2016, embora a quantidade de contribuições tenha sido semelhantes (57% dos republicanos vs 43% dos democratas), o valor arrecadado para os republicanos é bem maior (70% dos republicanos vs 30% dos democratas).

No segundo semestre de 2016, época das eleições gerais, vemos um comportamento interessante. Apesar dos democratas terem conseguido uma quantidade maior de doações, o republicanos receberam um montante maior. No mês de out/2016, com motante arrecadado bem próximo, fica bem claro que o valor médio das contribuições dos republicanos é maior neste periodo. Neste mes tivemos 81,65% das doações para os democratas mas o valor total das contribuições equivaliam apenas a 49,3% do total.

Como já haviamos notado nos histogramas, as quantidades de doações do demais partidos são insignificantes para nossa analise, tanto em valor total quanto em quantidade.


### Terceiro Gráfico
```{r echo=FALSE, Plot_Three}

#Para este gráfico optei fazer um gráfico para cada candidato ao invés de usar as opções de facet_wrap pois com este layer o espaço para a visualização do gráfico ficava muito reduzido.

df_por_candidato <- subset(USACampaign, 
      city %in% lista_ordenada("city", 10, ordenado_por = "total")$city &
      cand_nm %in% lista_ordenada("cand_nm", 7, ordenado_por = "total")$cand_nm) %>%
  group_by(city, cand_nm) %>%
  summarise(qtde = n(),
            vr_total = sum(contb_receipt_amt),
            vr_medio = mean(contb_receipt_amt)) %>%
  arrange(desc(vr_total))

ggplot(aes(y = vr_total, x = as.factor(city)), 
       data = df_por_candidato)+
  geom_point(aes(size = qtde, color = cand_nm))+
  scale_y_continuous(limits = c(0, 8e6), breaks = seq(0, 8e6, 500000))+
  scale_size_continuous(breaks = c(5000, 10000, 15000, 20000, 25000, 30000))+
  ylab('Valor total das doações')+
  xlab('Cidade')+
  labs(size = "Quantidade", color = "Candidato")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = c(.95, .95),
        legend.justification = c("right", "top"),
        legend.box.just = c("right", "top"),
        legend.margin = margin(6, 6, 6, 6),
        legend.box = "horizontal")+
  ggtitle("Distribuição dos votos nas cidades, por candidato")

lista_ordenada("city", 15)

```

### Descrição do Terceiro Gráfico

Este gráfico apresenta as 10 maiores cidades em valor de doação entre os 7 candidatos com mais contribuições. Nesta analise temos algumas observações inesperadas. Por exemplo, para o candidato **Marco Rubio**, a cidade de *Houston* teve a maior quantidade de doações, porém Dallas teve um valor maior total de contribuições.

Este grafico nos permites as seguintes analises:

- Houston foi a principal fonte de doações para todos os candidatos, embora não tenha sido a principal para Bernie Sanders (Austin teve maior arrecadação) e para Marco Rubio (Dallas).
- Embora Hillary Clinton tenha tido mais doações em cidades como Dallas e Houston, o montante total é menor do que aquela recebida por Ted Cruz. O mesmo é percebido pra Bernard Sanders em relação a Austin.
- As doações recebidas por Ted Cruz em Houston, representam mais do dobro da segunda cidade em doações.

------

# Reflexão

No início da projeto eu tinha em mente fazer utilização apenas dos dados disponíveis no dataset. A partir dele comecei a fazer a análise das distribuição de valores do estado de NY. Neste ponto me deparei com as questões citadas no início do documento, que me fizeram mudar minha análise para os dados de outro estado, o Texas.

Durante as primeiras análises percebi que muitos dados necessitavam de trartamento e então resolvi preparar um script em Python para realizar alguns ajustes. Outra observação feita com inicio do trabalho, foi que a necessidade de mais dados para análise e exclusão de algumas informações desnecessárias no dataset.

Um ponto importante que notei é que só consegui evoluir no trabalho a partir do momento que deixei claras quais eram os pontos que eu prentendia verificar. Antes disso era muito complicado encontrar quais gráficos deveriam ser feitos para a sequencia do trabalho. 

## Dificuldades encontradas

Uma dificuldade que tive foi de encontrar as regras sobre o limite de doações para os candidatos. Embora tenha encontrado a definição de limites de 2.700 por candidato, foi possível notar diversas contribuições acima deste valor, especialmente nas quantias de $5.400 e $10.800. 
 
Encontrei grandes dificuldades em se trabalhar com os mapas, principalmente devido as divergencias de dados para cruzamento de informações entre as base de mapa e o dataset das eleições, em especial na normalização dos nomes do munícipios.

## Conclusão

Apesar das dificuldades encontradas para a execução do trabalho, acredito que eu tenho obtido sucesso nas análises realizadas, conseguindo identificar o comportamento das doações realizadas na campanha presidencial de 2016 para o estado do Texas.

Durante as análises, foi interessante o comportamenta das doações para as eleições primárias e a gerais, mostrando como o canditato **Donald Trump** que não estava entre o candidatos com mais doações na primárias se tornou a opção dos republicanos. 

Outro ponto interessante foi visualizar como o candidato **Ted Cruz**, vencedor das eleições primárias no estado, foi o destino da grande parte das doações acima do U$ 5.400,00 (199 de 210).

Nas analises também podemos ver que, de forma geral, os republicanos foram os alvos preferidos da contribuições do estado do Texas, principalmente quando analisamos o ano de 2015.

## Futuros trabalhos

Para um futuro trabalho, seria interessante um estudo mais detalhado, onde tivessemos informações de renda e sexo dos contribuintes, bem como renda média da população nas cidades. Essa análise poderia apontar uma tendência nas doações realizadas em relação as preferencias por partido ou candidato.

Como tive dificuldades no cruzamento dos dados para trabalhar com os mapas, este um ponto que gostaria de explorar futuramente. Fiquei muito frustrado por não ter tempo hábil para ajustar as informações para apresentar alguns resultados de forma espacial, destacando as areas dos municípios. Era minha intenção:

- Apresentar a distribuição de valores doados e quantidades nas cidades
- Apresentar qual partido recebeu mais doação em cada estado, nas primárias e eleições gerais
- Apresentar a relação de população e quantidade de doações por cidade.

Além das propostas iniciais, existem diversas analises que poderiam ser apresentadas com base no mapa do Texas.

# Referências

Abaixo o link para referências usadas para este trabalho

- Arquivo detalhado de candidatos - [FEC](https://cg-519a459a-0ea3-42c2-b7bc-fa1143481f74.s3-us-gov-west-1.amazonaws.com/bulk-downloads/2016/cn16.zip)
- Arquivo detalhado de comites - [FEC](https://cg-519a459a-0ea3-42c2-b7bc-fa1143481f74.s3-us-gov-west-1.amazonaws.com/bulk-downloads/2016/cm16.zip)
- Arquivo SHP das cidades do estado do Texas - [United States Census](https://www.census.gov/geo/maps-data/data/cbf/cbf_cousub.html)
- Limites de contribuições por candidato - [FEC](https://transition.fec.gov/info/contriblimitschart1516.pdf)
- Datas das primarias - http://www.ncsl.org/research/elections-and-campaigns/2016-state-primary-dates.aspx

