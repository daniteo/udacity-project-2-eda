Contribuições da Campanha Presidencial America em 2016, estado do TX por Daniel Teobaldo
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Carregue aqui todos os pacotes utilizados 
# na sua análise realizada neste arquivo fonte.

# Note que o parâmetro "echo" foi definido como FALSE neste código.
# Isso previne que o código apresente resultados formatados em HTML.
# Você deve definir echo=FALSE para todos os blocos de código no seu arquivo.

library(ggplot2)
library(GGally)
library(scales)
library(memisc)
library(gridExtra)
library(maptools)
library(zipcode)
library(dplyr)
```

# Introdução

Para este projeto escolhi uma das bases de dados sugeridas pela Udacity: [Financiamento da Campanha Presidencial dos EUA de 2016](http://classic.fec.gov/disclosurep/pnational.do). 

A idéia inicial era de se fazer a analise do estado dde NY, no entanto havia uma discrepancia muito grande nas contibuições uma vez que o comite "HILLARY VICTORY FUND" teve quase metade (47%) do valor de contribuições referentes a este estado em apenas 23 contribuições das 649.460 contribuições registradas, todas acima de U$ 100.000. A maior contribuição abaixo deste valor de U$ 100.000 foi de U$ 11.816,25. A remoção dos *outliers* traria um dataset que não representaria o conjunto de dados do estado. 

```{r Dados auxiliares, echo = FALSE}
# Carga dos dados
# Carga dos dados dos comites baixados do site do FEC
cmte_data <- read.delim('cm.txt', sep = '|', header = F, col.names = c("cmte_id","CMTE_NM","TRES_NM",
                                                                     "CMTE_ST1","CMTE_ST1", "CMTE_CITY",
                                                                     "CMTE_ST","CMTE_ZIP","CMTE_DSGN",
                                                                     "CMTE_TP","CMTE_PTY_AFFILIATION",
                                                                     "CMTE_FILING_FREQ",
                                                                     "ORG_TP","CONNECTED_ORG_NM","CAND_ID"))

cmte_data <- cmte_data[c("cmte_id","CMTE_NM","CMTE_DSGN")]
```

```{r Outliers NY, echo = FALSE}
#Carga dos dodos de financiamento de NY
USACampaign <- read.csv('P00000001-NY.csv', header = T, as.is = T)
USACampaign <- left_join(USACampaign, cmte_data, by = c("cmte_id"))
rm(cmte_data)

summary(USACampaign$contb_receipt_amt)
USACampaign$contb_receipt_amt <- abs(USACampaign$contb_receipt_amt)
USACampaign$contb_range <- cut(USACampaign$contb_receipt_amt, c(0,100,500,2000,50000,max(USACampaign$contb_receipt_amt)))

USACampaign[USACampaign$contb_receipt_amt >= 100000,]$contbr_nm
max(USACampaign[USACampaign$contb_receipt_amt < 100000,]$contb_receipt_amt)

sum(USACampaign[USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED",]$contb_receipt_amt)
sum(USACampaign$contb_receipt_amt)*100

count(USACampaign[USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED",])

USACampaign$hillary_comitte <- ifelse(USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED", "Y", "N")

ggplot(aes(x=contb_range), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(aes(x=contb_range, y=contb_receipt_amt), 
       data = USACampaign)+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(y=contb_receipt_amt, x=cand_nm), 
       data = subset(USACampaign, contbr_nm != "HILLARY VICTORY FUND - UNITEMIZED"))+
  geom_boxplot()

sum(USACampaign[USACampaign$hillary_comitte == "Y",]$contb_receipt_amt)
sum(USACampaign[USACampaign$hillary_comitte == "N",]$contb_receipt_amt)

# plotbox com e sem contribuições altas


```

Esta discrepancia traria um prejuizo na avaliação das contribuições entre os candidatos e restringiria as analises dos dados. Desta forma optei por fazer a analise das contribuições feitas pelos eleitores do estado do TX, que traz uma distribuição mais homogenea nas contribuições.

```{r Verificação de dados}
USACampaign <- read.csv('P00000001-TX.csv', header = T, as.is = T)

# Verifica quantidade de registros com valores de contribuição negativa
dim(USACampaign[USACampaign$contb_receipt_amt < 0,])

# Verifica quantidade de registros com valores de contribuição igual a 0 (zero)
dim(USACampaign[USACampaign$contb_receipt_amt == 0,])

# Verifica a existencia de regitro diferentes para a mesma cidade, escritas de formas diferentes
table(USACampaign[substr(USACampaign$contbr_city, 1, 4) == "DALL",]$contbr_city)

```

Algumas verificações simples nesta base de dados nos aponta necessidade de tratamento das informações. Este tratamento será feito em um script a parte, em python (`tratarDados.py`). Maiores detalhes sobre este tratamentos pode ser visualizado no arquivo `Tratamento de dados.md`. 

```{r Carregar dados e resumo, echo=FALSE}
# Carregamento dos dados
USACampaign <- read.csv('P00000001-TX_tratado.csv', header = T, as.is = T)

max(USACampaign[USACampaign$contb_receipt_amt < 100000,]$contb_receipt_amt)

USACampaign$cmte_id <- as.factor(USACampaign$cmte_id)
USACampaign$cand_id <- as.factor(USACampaign$cand_id)
USACampaign$cand_nm <- as.factor(USACampaign$cand_nm)
USACampaign$contb_receipt_dt_month <- factor(USACampaign$contb_receipt_dt_month, ordered = T, 
                                                levels=c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", 
                                                         "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"))

USACampaign$contb_receipt_date <-  as.Date(USACampaign$contb_receipt_dt, "%d-%b-%y")
summary(USACampaign$contb_receipt_date)

#Detalhes do dataset
dim(USACampaign)
names(USACampaign)
str(USACampaign)
summary(USACampaign)


```

Este dataset do estado do Texas contem 548.396 observações com 28 variaveis. O dataset original (sem tratamento) contém 18 variáveis.

# Seção de Gráficos Univariados

Nesta primeira analise tentei identificar o período em que as contribuições ocorreram com mais frequencia. 

```{r Distribuição das doações ao longo do periodo, echo=FALSE}
summary(USACampaign$contb_receipt_date)

#Freqpoly das contribuições em todo periodo considerando um binwidth de 7 (1 semana)
ggplot(aes(x = contb_receipt_date), data = USACampaign)+
  geom_freqpoly(binwidth=7)+
  scale_x_date(date_breaks = "3 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2013-10-01","2016-12-31")))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período')

#Freqpoly das contribuições no ano de 2016 considerando um binwidth de 7 (1 semana)
ggplot(aes(x = contb_receipt_date), data = USACampaign)+
  geom_freqpoly(binwidth=7)+
  scale_x_date(date_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2016-01-01","2016-12-31")))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período em 2016')

```

```{r Quantidade de doações periodo, echo=FALSE}
ggplot(aes(x = contb_receipt_dt_year), data = USACampaign)+
  geom_histogram(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições por ano')

ggplot(aes(x = contb_receipt_dt_month), data = USACampaign)+
  geom_histogram(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap( ~contb_receipt_dt_year, ncol = 4)+
  ggtitle('Distribuição das contribuições por mes')
```
Quando gerei o primeiro gráfico com a distribuição dos valores, percebi uma contagem muito grande para as ocorrencias de menor valor (mais de 350.00). Reduzi então o binwidth em 10x para que as barras contivessem menos valores na mesma faixa uma vez que para valores baixos temos uma gama de valores muito grande. Depois reduzi o limite do eixo x com o objetivo de ter uma maior visibilidade das distribuições.

```{r Distribuição das contribuições por valor, echo = FALSE}

ggplot(aes(x=contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(binwidth = 100)+
  scale_x_continuous(breaks = seq(0, 15000, 2500))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(binwidth = 10)+
  scale_x_continuous(breaks = seq(0, 15000, 2500))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

summary(USACampaign$contb_receipt_amt)

quantile(USACampaign$contb_receipt_amt, 0.95)

ggplot(aes(x=contb_receipt_amt), 
       data = subset(USACampaign, contb_receipt_amt < 3000))+
  geom_histogram(binwidth = 10)+
  scale_x_continuous(breaks = seq(0, 3000, 500))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Removendo os outliers
ggplot(aes(x = contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(binwidth = 10)+
  scale_x_continuous(limits = c(0, quantile(USACampaign$contb_receipt_amt, 0.95)), breaks = seq(0, 3000, 200))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x = contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(bins=100)+
  scale_x_log10()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Cria faixa para os valores de contribuição
USACampaign$contb_receipt_amt_range <- cut(USACampaign$contb_receipt_amt, c(0,100,500,3000,50000,max(USACampaign$contb_receipt_amt)))

ggplot(aes(x=contb_receipt_amt_range), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r Distribuição das contribuições por partido, echo = FALSE}

ggplot(aes(x=party), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=party, y=contb_receipt_amt), 
       data = subset(USACampaign, contb_receipt_amt < quantile(USACampaign$contb_receipt_amt, 0.95)))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r Distribuição por comite, echo = FALSE}

USACampaign.by_cmte <- USACampaign %>%
                      group_by(cmte_nm) %>%
                      summarise(count = n()) %>%
                      arrange(desc(count))

comite_ordered <- USACampaign.by_cmte$cmte_nm

USACampaign$cmte_nm <- factor(USACampaign$cmte_nm, comite_ordered)

ggplot(aes(x=cmte_nm), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r Distribuição das contribuições na 25 maiores cidades}

USACampaign.by_city <- USACampaign %>%
                      group_by(city) %>%
                      summarise(count = n()) %>%
                      arrange(desc(count))

head(USACampaign.by_city, 25)

top10_city <- head(USACampaign.by_city, 25)$city

# Ordena as cidades com base na quantidade de contribuições
USACampaign$city_ordered <- factor(USACampaign$city, USACampaign.by_city$city)

# Distribuição das contribuições entre as cidades com mais contribuições
ggplot(aes(x=city_ordered), 
       data = subset(USACampaign, city %in% top10_city))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```


```{r Contirbuições por candidato, echo=FALSE}
USACampaign.by_cand <- USACampaign %>%
                       group_by(cand_nm) %>%
                       summarise(qtde = n(),
                       total_valor = sum(contb_receipt_amt),
                       media_valor = mean(contb_receipt_amt),
                       mediana_valor = median(contb_receipt_amt)) %>% 
                       arrange(qtde)

ggplot(aes(x = cand_nm), data = USACampaign)+
  geom_freqpoly(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE}
top3_occupation = head(unique(USACampaign$contbr_occupation), 3)

ggplot(aes(x = cand_nm), data = subset(USACampaign, contbr_occupation %in% top3_occupation))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap( ~contbr_occupation, ncol = 1 )+
  ggtitle('Distribuição das contribuições por candidato entre as 3 principais ocupações do contribuintes')
```

# Análise Univariada

### Qual é a estrutura do conjunto de dados?

O conjunto de dados possui 649443 registros de contribuições para o estado de NY, com 18 atributos cada.

### Quais são os principais atributos de interesse deste conjunto de dados?

Os principais atributos deste conjunto de dados são os candidatos (*cand_nm*) e os valores das contribuições (*contb_receipt_amt*).

### Quais outros atributos você acha que podem lhe auxiliar na investigação destes atributos de interesse?

### Você criou novas variáveis a partir dos atributos existentes no conjunto de dados?

Sim. Foram criados variaveis com os componentes da data de contribuição (dia, mês e ano) e incorporados dados do dataset de CEP (zipcode): cidade, longitude e latitude.

### Dos atributos investigados, distribuições incomuns foram encontradas? Você aplicou operações nos dados para limpá-los, ajustá-los ou mudar a forma dos dados? Se sim, por quê?

Foram realizados tratamentos nos valores de contribuição. Para os valores negativos, foi considerado o valor absoluto. As contribuições zeradas foram eliminadas.

As datas de contribuição carregadas originalmente como `caracter`, foram convertidas para `Date`.

Conforme apresentado na seção de tratamento de dados, fiz uma ajuste nos nomes das cidades para eleminar as cidades iguais registradas com grafias diferentes.

# Seção de Gráficos Bivariados

Aqui fiz uma analise das distriuição dos valores ao longo do tempo. No primeiro gráfico foi feita uma analise mais ampla por todo o período compreendido no dataset. No segundo reduzi o faixa de valores para o ano de 2016 e foi considerada as contribuições realizadas dentro de 99% da amostragem.

```{r Valores de contrbuição ao longo do tempo, echo = FALSE}
ggplot(aes(x = contb_receipt_date, y = contb_receipt_amt), 
       data = USACampaign)+
  geom_point(alpha = 1/20)+
  scale_x_date(date_breaks = "3 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y")+
  scale_y_continuous(breaks = seq(0, 17500, 1000))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período')


ggplot(aes(x = contb_receipt_date, y = contb_receipt_amt), 
       data = USACampaign)+
  geom_point(alpha = 1/50)+
  scale_x_date(date_breaks = "3 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2016-01-01","2016-12-31")))+
  scale_y_continuous(breaks = seq(0, 6000, 500), limits = c(0, quantile(USACampaign$contb_receipt_amt, 0.99)))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período')
```

Nesta analise podemos perceber a presença de faixas horizontais bem definidas para os valores doados com mais frequncias. Estes normalmente ão valores redodndos. Uma faixa bem definida é a 2700 dolares. Talvez houvesse uma opção explicita neste valor, ou fosse um teto de contribuição. 

Estas mesmas faixas podem ser percebidas quando analisamos a os valores de contribuição por candidato, como visto abaixo.
```{r Valor de contibuições para cada candidato, echo=FALSE}
ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point()+
  ylim(0, quantile(USACampaign$contb_receipt_amt, 0.99))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point(alpha = 1/50, position = 'jitter')+
  scale_y_continuous(limits = c(0, quantile(USACampaign$contb_receipt_amt, 0.99)),
                     breaks = seq(0, 3000, 250))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r Distribuição das contribuições por partido e candidato, echo = FALSE}

ggplot(aes(x=party, fill = cand_nm), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="bottom")

ggplot(aes(x=party, y=contb_receipt_amt, fill = cand_nm), 
       data = USACampaign)+
  geom_bar(stat = 'sum')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="bottom")

```

```{r Valor médio das contribuições, echo=FALSE}
ggplot(aes(x=cand_nm, y=contb_receipt_amt), data = USACampaign)+
  geom_bar(stat = 'summary', fun.y = mean, fill = I('#AACC99'))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=city_ordered, y=contb_receipt_amt), 
       data = subset(USACampaign, city %in% top10_city))+
  geom_bar(stat = 'summary', fun.y = sum, fill = I('#AACC99'))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```



# Análise Bivariada

### Discuta sobre alguns dos relacionamentos observados nesta parte da investigação. Como os atributos de interesse variaram no conjunto de dados?

### Você observou algum relacionamento interessante entre os outros atributos (os que não são de interesse)?

### Qual foi o relacionamento mais forte encontrado?




# Seção de Gráficos Multivariados

```{r echo=FALSE, Multivariate_Plots}
#set.seed(20022012)

ggplot(aes(x = lon, y = lat, color = cand_nm),
       data = subset(USACampaign, !is.na(city)))+
  geom_point()+
  theme(legend.position="bottom")
  #guides(color=FALSE)

```

# Análise Multivariada

### Discuta sobre os relacionamentos observados nesta parte da investigação. Quais atributos que fortaleceram os demais na observação das variáveis de interesse?

### Interações surpreendentes e/ou interessantes foram encontradas entre os atributos?

### OPCIONAL: Modelos foram criados usando este conjunto de dados? Discuta sobre os pontos fortes e as limitações do seu modelo.

------

# Gráficos Finais e Sumário

### Primeiro Gráfico
```{r echo=FALSE, Plot_One}

```

### Descrição do Primeiro Gráfico


### Segundo Gráfico
```{r echo=FALSE, Plot_Two}

```

### Descrição do Segundo Gráfico


### Terceiro Gráfico
```{r echo=FALSE, Plot_Three}

```

### Descrição do Terceiro Gráfico

------

# Reflexão


