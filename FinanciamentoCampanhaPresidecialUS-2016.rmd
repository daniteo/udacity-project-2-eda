Contribuições da Campanha Presidencial America em 2016, estado do TX por Daniel Teobaldo
========================================================

```{r echo=FALSE, message=FALSE, warning=FALSE, packages}
# Carregue aqui todos os pacotes utilizados 
# na sua análise realizada neste arquivo fonte.

# Note que o parâmetro "echo" foi definido como FALSE neste código.
# Isso previne que o código apresente resultados formatados em HTML.
# Você deve definir echo=FALSE para todos os blocos de código no seu arquivo.

library(ggplot2)
library(GGally)
library(scales)
library(memisc)
library(gridExtra)
library(maptools)
library(zipcode)
library(dplyr)
```

# Introdução

Para este projeto escolhi uma das bases de dados sugeridas pela Udacity: [Financiamento da Campanha Presidencial dos EUA de 2016](http://classic.fec.gov/disclosurep/pnational.do). 

A idéia inicial era de se fazer a analise do estado dde NY, no entanto havia uma discrepancia muito grande nas contibuições uma vez que o comite "HILLARY VICTORY FUND" teve quase metade (47%) do valor de contribuições referentes a este estado em apenas 23 contribuições das 649.460 contribuições registradas, todas acima de U$ 100.000. A maior contribuição abaixo deste valor de U$ 100.000 foi de U$ 11.816,25. A remoção dos *outliers* traria um dataset que não representaria o conjunto de dados do estado. 

```{r Dados auxiliares, echo = FALSE}
# Carga dos dados
# Carga dos dados dos candidatos baixados do site do FEC
cand_data <- read.delim('cn.txt', sep = '|', header = F)
cand_data <- cand_data[cand_data$V4 == 2016,]
str(cand_data)
# Carga dos dados dos comites baixados do site do FEC
cmte_data <- read.delim('cm.txt', sep = '|', header = F, col.names = c("CMTE_ID","CMTE_NM","TRES_NM",
                                                                     "CMTE_ST1","CMTE_ST1", "CMTE_CITY",
                                                                     "CMTE_ST","CMTE_ZIP","CMTE_DSGN",
                                                                     "CMTE_TP","CMTE_PTY_AFFILIATION",
                                                                     "CMTE_FILING_FREQ",
                                                                     "ORG_TP","CONNECTED_ORG_NM","CAND_ID"))
```

```{r Outliers NY, echo = FALSE}
#Carga dos dodos de financiamento de NY
USACampaign <- read.csv('P00000001-NY.csv', header = T, as.is = T)
USACampaign <- left_join(USACampaign, comitte, by = c("cmte_id"))
summary(USACampaign$contb_receipt_amt)
USACampaign$contb_receipt_amt <- abs(USACampaign$contb_receipt_amt)
USACampaign$contb_range <- cut(USACampaign$contb_receipt_amt, c(0,100,500,2000,50000,max(USACampaign$contb_receipt_amt)))

USACampaign[USACampaign$contb_receipt_amt >= 100000,]$contbr_nm
max(USACampaign[USACampaign$contb_receipt_amt < 100000,]$contb_receipt_amt)

sum(USACampaign[USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED",]$contb_receipt_amt)
sum(USACampaign$contb_receipt_amt)*100

count(USACampaign[USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED",])

USACampaign$hillary_comitte <- ifelse(USACampaign$contbr_nm == "HILLARY VICTORY FUND - UNITEMIZED", "Y", "N")

ggplot(aes(x=contb_range), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


ggplot(aes(x=contb_range, y=contb_receipt_amt), 
       data = USACampaign)+
  geom_bar(stat = 'summary', fun.y = 'sum')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(y=contb_receipt_amt, x=cand_nm), 
       data = subset(USACampaign, contbr_nm != "HILLARY VICTORY FUND - UNITEMIZED"))+
  geom_boxplot()

sum(USACampaign[USACampaign$hillary_comitte == "Y",]$contb_receipt_amt)
sum(USACampaign[USACampaign$hillary_comitte == "N",]$contb_receipt_amt)


```

Esta discrepancia traria um prejuizo na avaliação das contribuições entre os candidatos e restringiria as analises dos dados. Desta forma optei por fazer a analise das contribuições feitas pelos eleitores do estado do TX, que traz uma distribuição mais homogenea nas contribuições.

Este dataset contem 548.396 observações com 18 variaveis.

```{r Carregar dados e resumo, echo=FALSE}
# Carregamento dos dados
USACampaign <- read.csv('P00000001-TX_tratado.csv', header = T, as.is = T)

max(USACampaign[USACampaign$contb_receipt_amt < 100000,]$contb_receipt_amt)

# Conversão dos candidatos para factor
USACampaign$cmte_id <- as.factor(USACampaign$cmte_id)
USACampaign$cand_id <- as.factor(USACampaign$cand_id)
USACampaign$cand_nm <- as.factor(USACampaign$cand_nm)
USACampaign$contb_receipt_dt_month <- factor(USACampaign$contb_receipt_dt_month, ordered = T, 
                                                levels=c("JAN", "FEB", "MAR", "APR", "MAY", "JUN", 
                                                         "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"))
levels(USACampaign$cand_nm)

#Detalhes do dataset
dim(USACampaign)
names(USACampaign)
str(USACampaign)
summary(USACampaign)

ggplot(aes(x=cmte_nm), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=contb_receipt_amt), 
       data = USACampaign)+
  geom_histogram(bins=50)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### Escalas de contribuição


```{r Faixas de contribuição, echo = FALSE}
summary(USACampaign$contb_receipt_amt)

USACampaign$contb_receipt_amt_range <- cut(USACampaign$contb_receipt_amt, c(0,100,500,2000,50000,max(USACampaign$contb_receipt_amt)))

ggplot(aes(x=contb_receipt_amt_range), 
       data = USACampaign)+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Seção de Gráficos Univariados

O primeira analise é tentar identificar o periodo em que as contribuições ocorreram com mais frequencia.

```{r Distribuição das doações ao longo do periodo, echo=FALSE}
summary(USACampaign$contb_receipt_date)

ggplot(aes(x = contb_receipt_date), data = USACampaign)+
  geom_freqpoly(binwidth=7)+
  scale_x_date(date_breaks = "3 months", 
               date_minor_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2013-10-01","2016-12-31")))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período')

ggplot(aes(x = contb_receipt_date), data = USACampaign)+
  geom_freqpoly(binwidth=7)+
  scale_x_date(date_breaks = "1 months", 
               date_labels = "%b/%Y",
               limits = as.Date(c("2016-01-01","2016-12-31")))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  ggtitle('Distribuição das contribuições no período em 2016')

```

```{r Quantidade de doações por candidato, echo=FALSE}
ggplot(aes(x = contb_receipt_dt_year), data = USACampaign)+
  geom_histogram(binwidth=5, stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x = contb_receipt_dt_month), data = USACampaign)+
  geom_histogram(binwidth=5, stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap( ~contb_receipt_dt_year, ncol = 4)
```

```{r Distribuicão dos valores das contribuições, echo=FALSE}


ggplot(aes(x = contb_receipt_amt), data = USACampaign)+
  geom_histogram(binwidth=100)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Identificando as 25 maiores contibuições do dataset
head(sort(USACampaign$contb_receipt_amt, decreasing = T), 25)

#Contribuintes que doaram mais que U$ 100.000,00
USACampaign[USACampaign$contb_receipt_amt>100000,]$contbr_nm

ggplot(aes(x = contb_receipt_amt), data = USACampaign)+
  geom_histogram(bins=100)+
  xlim(0,quantile(USACampaign$contb_receipt_amt, 0.99))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x = contb_receipt_amt), data = USACampaign)+
  geom_histogram(bins=100)+
  xlim(0,1000)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x = contb_receipt_amt), data = USACampaign)+
  geom_histogram(bins=100)+
  scale_x_log10()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

USACampaign.by_contb <- USACampaign %>%
                      group_by(contbr_nm) %>%
                      summarise(count = n(),
                                soma = sum(contb_receipt_amt)) %>%
                      arrange(desc(soma))

ggplot(aes(x = contbr_nm, y=soma), data = USACampaign.by_contb)+
  geom_bar(stat = 'identity')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))



```

```{r Contirbuições por cidade, echo=FALSE}
USACampaign.by_city <- USACampaign %>%
                      group_by(city) %>%
                      summarise(count = n()) %>%
                      arrange(desc(count))

main_city <- head(USACampaign.by_city$city, 10)

ggplot(aes(x = city), data = subset(USACampaign, city %in% main_city))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r Contirbuições por candidato, echo=FALSE}
USACampaign.by_cand <- USACampaign %>%
                       group_by(cand_nm) %>%
                       summarise(qtde = n(),
                       total_valor = sum(contb_receipt_amt),
                       media_valor = mean(contb_receipt_amt),
                       mediana_valor = median(contb_receipt_amt)) %>% 
                       arrange(qtde)

ggplot(aes(x = cand_nm), data = USACampaign)+
  geom_freqpoly(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r echo=FALSE}
top3_occupation = head(unique(USACampaign$contbr_occupation), 3)

ggplot(aes(x = cand_nm), data = subset(USACampaign, contbr_occupation %in% top3_occupation))+
  geom_bar(stat = 'count')+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap( ~contbr_occupation, ncol = 1 )+
  ggtitle('Distribuição das contribuições por candidato entre as 3 principais ocupações do contribuintes')
```

# Análise Univariada

### Qual é a estrutura do conjunto de dados?

O conjunto de dados possui 649443 registros de contribuições para o estado de NY, com 18 atributos cada.

### Quais são os principais atributos de interesse deste conjunto de dados?

Os principais atributos deste conjunto de dados são os candidatos (*cand_nm*) e os valores das contribuições (*contb_receipt_amt*).

### Quais outros atributos você acha que podem lhe auxiliar na investigação destes atributos de interesse?

### Você criou novas variáveis a partir dos atributos existentes no conjunto de dados?

Sim. Foram criados variaveis com os componentes da data de contribuição (dia, mês e ano) e incorporados dados do dataset de CEP (zipcode): cidade, longitude e latitude.

### Dos atributos investigados, distribuições incomuns foram encontradas? Você aplicou operações nos dados para limpá-los, ajustá-los ou mudar a forma dos dados? Se sim, por quê?

Foram realizados tratamentos nos valores de contribuição. Para os valores negativos, foi considerado o valor absoluto. As contribuições zeradas foram eliminadas.

As datas de contribuição carregadas originalmente como `caracter`, foram convertidas para `Date`.

Conforme apresentado na seção de tratamento de dados, fiz uma ajuste nos nomes das cidades para eleminar as cidades iguais registradas com grafias diferentes.

# Seção de Gráficos Bivariados
```{r Valor de contibuições para cada candidato, echo=FALSE}
ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point()+
  ylim(0, quantile(USACampaign$contb_receipt_amt, 0.99))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(aes(x=cand_nm, y=contb_receipt_amt), data=USACampaign)+
  geom_point(alpha = 1/50, position = 'jitter')+
  scale_y_continuous(limits = c(0, quantile(USACampaign$contb_receipt_amt, 0.99)),
                     breaks = seq(0, 3000, 250))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r Valor médio das contribuições, echo=FALSE}
ggplot(aes(x=cand_nm, y=contb_receipt_amt), data = USACampaign)+
#  geom_bar(stat = 'summary', fun.y = median)+
  geom_bar(stat = 'summary', fun.y = mean, fill = I('#AACC99'), position = "dodge")+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


# Análise Bivariada

### Discuta sobre alguns dos relacionamentos observados nesta parte da investigação. Como os atributos de interesse variaram no conjunto de dados?

### Você observou algum relacionamento interessante entre os outros atributos (os que não são de interesse)?

### Qual foi o relacionamento mais forte encontrado?




# Seção de Gráficos Multivariados

```{r echo=FALSE, Multivariate_Plots}
set.seed(20022012)

```

# Análise Multivariada

### Discuta sobre os relacionamentos observados nesta parte da investigação. Quais atributos que fortaleceram os demais na observação das variáveis de interesse?

### Interações surpreendentes e/ou interessantes foram encontradas entre os atributos?

### OPCIONAL: Modelos foram criados usando este conjunto de dados? Discuta sobre os pontos fortes e as limitações do seu modelo.

------

# Gráficos Finais e Sumário

### Primeiro Gráfico
```{r echo=FALSE, Plot_One}

```

### Descrição do Primeiro Gráfico


### Segundo Gráfico
```{r echo=FALSE, Plot_Two}

```

### Descrição do Segundo Gráfico


### Terceiro Gráfico
```{r echo=FALSE, Plot_Three}

```

### Descrição do Terceiro Gráfico

------

# Reflexão


